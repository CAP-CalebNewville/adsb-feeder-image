#!/bin/bash

# set up the right config files and then pass the arguments
# on to docker compose

# this needs to run as root
if [ $(id -u) != "0" ] ; then
	echo "this command requires superuser privileges - please run as sudo bash $0"
	exit 1
fi

lockFile="/opt/adsb/docker-starting.lock"
if ( set -o noclobber; echo "locked" > "$lockFile") 2> /dev/null; then
	trap 'rm -f "$lockFile"; exit $?' INT TERM EXIT
else
	echo "docker-compose-adsb is already running" >&2
	exit
fi

docker_compose="docker compose"
$docker_compose version &> /dev/null || docker_compose="docker-compose"

if grep _ADSBIM_STATE_IS_RADARBOX_ENABLED=True /opt/adsb/config/.env ; then
	# time for the radarbox hacks
	mkdir -p /opt/adsb/rb/thermal_zone0
	if grep -i serial /proc/cpuinfo ; then
		sed -i '/FEEDER_RB_CPUINFO_HACK/d' /opt/adsb/config/.env
	else
		if [ ! -f /opt/adsb/rb/cpuinfo ] ; then
			cat /proc/cpuinfo > /opt/adsb/rb/cpuinfo
			echo -e "Serial\t\t: $(echo $RANDOM$RANDOM $RANDOM$RANDOM | awk '{printf "%08x%08x", $1, $2 }')" >> /opt/adsb/rb/cpuinfo
		fi
		if ! grep FEEDER_RB_CPUINFO_HACK=/proc/cpuinfo /opt/adsb/config/.env &> /dev/null ; then
			sed -i '/FEEDER_RB_CPUINFO_HACK/d' /opt/adsb/config/.env
			echo "FEEDER_RB_CPUINFO_HACK=/proc/cpuinfo" >> /opt/adsb/config/.env
		fi
	fi
	if [ -f /sys/class/thermal/thermal_zone0/temp ] ; then
		sed -i "/FEEDER_RB_THERMAL_HACK/d" /opt/adsb/config/.env
	else
		if [ ! -f /opt/adsb/rb/thermal_zone0/temp ] ; then
			echo 12345 > /opt/adsb/rb/thermal_zone0/temp
		fi
		if ! grep FEEDER_RB_THERMAL_HACK=/sys/class/thermal/thermal_zone0 /opt/adsb/config/.env &> /dev/null ; then
			sed -i "/FEEDER_RB_THERMAL_HACK/d" /opt/adsb/config/.env
			echo "FEEDER_RB_THERMAL_HACK=/sys/class/thermal/thermal_zone0" >> /opt/adsb/config/.env
		fi
	fi
fi

if grep "_ADSBIM_STATE_IS_BASE_CONFIG_FINISHED=True" /opt/adsb/config/.env > /dev/null 2>&1 ; then
	echo "calling docker compose for the enabled containers"
	source /opt/adsb/default.docker-compose
	cd /opt/adsb/config
	$docker_compose "${COMPOSE_FILES[@]}" "$@"
else
	echo "things aren't configured, yet, only starting Dozzle and the logger container"
	$docker_compose -f /opt/adsb/config/dozzle.yml "$@"
fi
